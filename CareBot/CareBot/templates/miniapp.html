<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CareBot Mini App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: var(--tg-theme-bg-color, #fff);
            color: var(--tg-theme-text-color, #000);
        }
        .container {
            max-width: 400px;
            margin: 0 auto;
        }
        .mission-card {
            background: var(--tg-theme-secondary-bg-color, #f1f1f1);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid var(--tg-theme-hint-color, #ccc);
        }
        .mission-id {
            font-size: 18px;
            font-weight: bold;
            color: var(--tg-theme-accent-text-color, #007aff);
            margin-bottom: 8px;
        }
        .mission-title {
            font-size: 16px;
            margin-bottom: 8px;
        }
        .mission-details {
            font-size: 14px;
            color: var(--tg-theme-hint-color, #666);
        }
        .btn {
            background: var(--tg-theme-button-color, #007aff);
            color: var(--tg-theme-button-text-color, #fff);
            border: none;
            border-radius: 8px;
            padding: 12px 16px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
            margin-top: 8px;
        }
        .btn:hover {
            opacity: 0.8;
        }
        .loading {
            text-align: center;
            padding: 40px 20px;
        }
        .error {
            color: #ff3b30;
            text-align: center;
            padding: 20px;
        }
        .map-container {
            background: var(--tg-theme-secondary-bg-color, #f8f8f8);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }
        .hex-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 4px;
            max-width: 200px;
            margin: 0 auto;
        }
        .hex {
            aspect-ratio: 1;
            background: var(--tg-theme-hint-color, #ddd);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }
        .hex.active {
            background: var(--tg-theme-accent-text-color, #007aff);
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéØ CareBot Mini App</h1>
        
        <!-- –ö–∞—Ä—Ç–∞ -->
        <div class="map-container">
            <h2>üó∫Ô∏è –ö–∞—Ä—Ç–∞ –∫–∞–º–ø–∞–Ω–∏–∏</h2>
            <div class="hex-grid" id="hexGrid">
                <!-- Hexes –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
            </div>
            <p><small>–ê–∫—Ç–∏–≤–Ω—ã–µ –º–∏—Å—Å–∏–∏ –≤—ã–¥–µ–ª–µ–Ω—ã —Å–∏–Ω–∏–º</small></p>
        </div>
        
        <!-- –°–ø–∏—Å–æ–∫ –º–∏—Å—Å–∏–π -->
        <div id="missionsContainer">
            <div class="loading">
                <p>üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ –º–∏—Å—Å–∏–π...</p>
            </div>
        </div>
    </div>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ü–≤–µ—Ç–æ–≤—É—é —Å—Ö–µ–º—É Telegram
        document.body.style.backgroundColor = tg.themeParams.bg_color || '#ffffff';
        document.body.style.color = tg.themeParams.text_color || '#000000';

        // –ó–∞–≥—Ä—É–∑–∫–∞ –º–∏—Å—Å–∏–π
        async function loadMissions() {
            try {
                const response = await fetch('/api/missions');
                const data = await response.json();
                
                displayMissions(data.missions);
                updateHexGrid(data.missions);
            } catch (error) {
                console.error('Error loading missions:', error);
                displayError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∏—Å—Å–∏–π');
            }
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–∏—Å—Å–∏–π
        function displayMissions(missions) {
            const container = document.getElementById('missionsContainer');
            
            if (missions.length === 0) {
                container.innerHTML = '<div class="error">üì≠ –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –º–∏—Å—Å–∏–π</div>';
                return;
            }

            const missionsHtml = missions.map(mission => `
                <div class="mission-card">
                    <div class="mission-id">üìã ${mission.short_id}</div>
                    <div class="mission-title">${mission.title}</div>
                    <div class="mission-details">
                        üìç Hex ${mission.hex_id} | 
                        üéÆ ${mission.mission_type} | 
                        üë• ${mission.participants_count} –∏–≥—Ä–æ–∫–æ–≤
                    </div>
                    <div class="mission-details">
                        üìÖ ${new Date(mission.created_at).toLocaleString('ru-RU')}
                    </div>
                    <button class="btn" onclick="viewMission('${mission.short_id}')">
                        üìñ –ü–æ–¥—Ä–æ–±–Ω–µ–µ
                    </button>
                </div>
            `).join('');

            container.innerHTML = `
                <h2>üéØ –ê–∫—Ç–∏–≤–Ω—ã–µ –º–∏—Å—Å–∏–∏ (${missions.length})</h2>
                ${missionsHtml}
            `;
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ hex —Å–µ—Ç–∫–∏
        function updateHexGrid(missions) {
            const hexGrid = document.getElementById('hexGrid');
            const activeMissions = new Set(missions.map(m => m.hex_id));
            
            // –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç—É—é 5x5 —Å–µ—Ç–∫—É
            let hexesHtml = '';
            for (let i = 1; i <= 25; i++) {
                const isActive = activeMissions.has(i);
                hexesHtml += `
                    <div class="hex ${isActive ? 'active' : ''}" onclick="selectHex(${i})">
                        ${i}
                    </div>
                `;
            }
            
            hexGrid.innerHTML = hexesHtml;
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        function viewMission(missionId) {
            tg.showAlert(`–ú–∏—Å—Å–∏—è ${missionId}\n\n–î–ª—è –≤–≤–æ–¥–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É –≤ –±–æ—Ç–µ:\n/result ${missionId} [–≤–∞—à–∏_–æ—á–∫–∏] [–æ—á–∫–∏_–ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞]`);
        }

        function selectHex(hexId) {
            tg.showAlert(`Hex ${hexId}\n\n–ó–¥–µ—Å—å –º–æ–∂–Ω–æ —Ä–∞–∑–º–µ—Å—Ç–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–ª–µ—Ç–∫–µ –∫–∞—Ä—Ç—ã`);
        }

        function displayError(message) {
            document.getElementById('missionsContainer').innerHTML = 
                `<div class="error">${message}</div>`;
        }

        // –ö–Ω–æ–ø–∫–∞ "–û–±–Ω–æ–≤–∏—Ç—å" –≤ Telegram
        tg.MainButton.text = "üîÑ –û–±–Ω–æ–≤–∏—Ç—å";
        tg.MainButton.show();
        tg.MainButton.onClick(loadMissions);

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
        loadMissions();
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
        setInterval(loadMissions, 30000);
    </script>
</body>
</html>
