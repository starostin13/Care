#!/bin/bash

# ะกะบัะธะฟั ัััะฐะฝะพะฒะบะธ cron ะทะฐะดะฐั ะดะปั ะฐะฒัะพะผะฐัะธัะตัะบะพะณะพ ะฑัะบะฐะฟะฐ CareBot
# ะะฐะฟััะบะฐัั ะฝะฐ ัะตัะฒะตัะต Ubuntu

set -e

PROJECT_DIR="/home/ubuntu/carebot"
BACKUP_SCRIPT="$PROJECT_DIR/scripts/backup-database.sh"

echo "๐ง ะะฐัััะพะนะบะฐ ะฐะฒัะพะผะฐัะธัะตัะบะธั ะฑัะบะฐะฟะพะฒ CareBot..."

# ะัะพะฒะตัะบะฐ ัััะตััะฒะพะฒะฐะฝะธั ัะบัะธะฟัะฐ ะฑัะบะฐะฟะฐ
if [ ! -f "$BACKUP_SCRIPT" ]; then
    echo "โ ะกะบัะธะฟั ะฑัะบะฐะฟะฐ ะฝะต ะฝะฐะนะดะตะฝ: $BACKUP_SCRIPT"
    exit 1
fi

# ะะตะปะฐะตะผ ัะบัะธะฟั ะธัะฟะพะปะฝัะตะผัะผ
chmod +x "$BACKUP_SCRIPT"
echo "โ ะกะบัะธะฟั ะฑัะบะฐะฟะฐ ัะดะตะปะฐะฝ ะธัะฟะพะปะฝัะตะผัะผ"

# ะกะพะทะดะฐะฝะธะต ะฒัะตะผะตะฝะฝะพะณะพ ัะฐะนะปะฐ crontab
TEMP_CRON=$(mktemp)

# ะะพะปััะตะฝะธะต ัะตะบััะตะณะพ crontab (ะตัะปะธ ะตััั)
crontab -l 2>/dev/null > "$TEMP_CRON" || true

# ะฃะดะฐะปะตะฝะธะต ััะฐััั ะทะฐะฟะธัะตะน ะฑัะบะฐะฟะฐ CareBot
sed -i '/# CareBot backup/d' "$TEMP_CRON"
sed -i '/backup-database.sh/d' "$TEMP_CRON"

echo "" >> "$TEMP_CRON"
echo "# CareBot backup jobs - ะฐะฒัะพะผะฐัะธัะตัะบะธ ัะพะทะดะฐะฝะพ $(date)" >> "$TEMP_CRON"

# ะะถะตะดะฝะตะฒะฝัะน ะฑัะบะฐะฟ ะฒ 3:30 ัััะฐ
echo "30 3 * * * cd $PROJECT_DIR && ./scripts/backup-database.sh >> /tmp/carebot_backup.log 2>&1 # CareBot backup daily" >> "$TEMP_CRON"

# ะะถะตะฝะตะดะตะปัะฝัะน ะฟะพะปะฝัะน ะฑัะบะฐะฟ ะฟะพ ะฒะพัะบัะตัะตะฝััะผ ะฒ 2:00 ัััะฐ (ั ะฟัะธะฝัะดะธัะตะปัะฝะพะน ะพัะธััะบะพะน ะปะพะณะพะฒ)
echo "0 2 * * 0 cd $PROJECT_DIR && ./scripts/backup-database.sh > /tmp/carebot_backup_weekly.log 2>&1 # CareBot backup weekly" >> "$TEMP_CRON"

# ะะถะตะผะตัััะฝะฐั ะพัะธััะบะฐ ััะฐััั ะปะพะณะพะฒ (1-ะณะพ ัะธัะปะฐ ะฒ 1:00)
echo "0 1 1 * * find /tmp -name '*carebot_backup*.log' -mtime +30 -delete 2>/dev/null # CareBot backup log cleanup" >> "$TEMP_CRON"

# ะฃััะฐะฝะพะฒะบะฐ ะฝะพะฒะพะณะพ crontab
crontab "$TEMP_CRON"

# ะฃะดะฐะปะตะฝะธะต ะฒัะตะผะตะฝะฝะพะณะพ ัะฐะนะปะฐ
rm "$TEMP_CRON"

echo "โ Cron ะทะฐะดะฐัะธ ัััะฐะฝะพะฒะปะตะฝั:"
echo "   ๐ ะะถะตะดะฝะตะฒะฝะพ ะฒ 03:30 - ัะพะทะดะฐะฝะธะต ะฑัะบะฐะฟะฐ"
echo "   ๐ ะะถะตะฝะตะดะตะปัะฝะพ ะฒ 02:00 (ะฒะพัะบัะตัะตะฝัะต) - ะฟะพะปะฝัะน ะฑัะบะฐะฟ"
echo "   ๐ ะะถะตะผะตัััะฝะพ ะฒ 01:00 (1-ะณะพ ัะธัะปะฐ) - ะพัะธััะบะฐ ะปะพะณะพะฒ"

echo ""
echo "๐ ะขะตะบััะธะต cron ะทะฐะดะฐัะธ:"
crontab -l | grep -E "(CareBot|backup-database)" || echo "   (ะะตั ะทะฐะดะฐั CareBot)"

echo ""
echo "๐ ะะฐัะฟะธัะฐะฝะธะต ะฑัะบะฐะฟะพะฒ:"
echo "   โฐ ะะถะตะดะฝะตะฒะฝะพ: ะบะฐะถะดัะน ะดะตะฝั ะฒ 03:30"
echo "   โฐ ะะถะตะฝะตะดะตะปัะฝะพ: ะบะฐะถะดะพะต ะฒะพัะบัะตัะตะฝัะต ะฒ 02:00"
echo "   ๐งน ะัะธััะบะฐ ะปะพะณะพะฒ: 1-ะณะพ ัะธัะปะฐ ะบะฐะถะดะพะณะพ ะผะตัััะฐ ะฒ 01:00"

echo ""
echo "๐ ะะพะณะธ ะฑัะบะฐะฟะพะฒ:"
echo "   ๐ ะะถะตะดะฝะตะฒะฝัะต: /tmp/carebot_backup.log"
echo "   ๐ ะะถะตะฝะตะดะตะปัะฝัะต: /tmp/carebot_backup_weekly.log"

echo ""
echo "๐ ะะฒัะพะผะฐัะธัะตัะบะธะต ะฑัะบะฐะฟั ะฝะฐัััะพะตะฝั ััะฟะตัะฝะพ!"
echo "๐ ะะปั ะฟัะพะฒะตัะบะธ ััะฐัััะฐ: crontab -l | grep CareBot"